generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  EDITOR
  VIEWER
}

enum InputType {
  RAW
  STRUCTURED
  IMPORTED
  COPYWRITER
}

enum ExportFormat {
  PDF
  EPUB
  DOCX
  BUNDLE
}

enum ExportStatus {
  PENDING
  SUCCESS
  FAILED
}

enum WebhookEvent {
  DOCUMENT_PROCESSED
  EXPORT_COMPLETED
  EXPORT_FAILED
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  apiKeys     ApiKey[]
  documents   Document[]
  templates   Template[]
  exports     ExportArtifact[]
  webhooks    WebhookEndpoint[]
  deliveries  WebhookDelivery[]
  featureFlags FeatureFlag[]
}

model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String
  fullName     String
  passwordHash String
  role         UserRole @default(EDITOR)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
}

model ApiKey {
  id         String   @id @default(cuid())
  tenantId   String
  name       String
  keyHash    String
  createdBy  String
  lastUsedAt DateTime?
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Template {
  id          String   @id @default(cuid())
  tenantId    String?
  key         String   @unique
  name        String
  description String
  config      Json
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Document {
  id               String    @id @default(cuid())
  tenantId         String
  createdBy        String
  inputType        InputType
  title            String
  rawText          String
  sourceReference  String?
  templateId       String
  spineAd          Float
  spinePm          Float
  spineEsi         Float
  metadata         Json?
  normalizedText   String?
  chapters         Json?
  toc              Json?
  layout           Json?
  processingDigest String?
  processedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant  Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  exports ExportArtifact[]

  @@index([tenantId, createdAt])
}

model ExportArtifact {
  id          String       @id @default(cuid())
  tenantId    String
  documentId  String
  format      ExportFormat
  status      ExportStatus @default(PENDING)
  filename    String?
  mimeType    String?
  bytes       Int?
  sha256      String?
  storagePath String?
  manifest    Json?
  error       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId, documentId, createdAt])
}

model WebhookEndpoint {
  id        String       @id @default(cuid())
  tenantId  String
  event     WebhookEvent
  targetUrl String
  secret    String
  active    Boolean      @default(true)
  createdAt DateTime     @default(now())

  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([tenantId, event])
}

model WebhookDelivery {
  id           String       @id @default(cuid())
  tenantId     String
  endpointId   String
  event        WebhookEvent
  payload      Json
  statusCode   Int?
  responseBody String?
  success      Boolean
  deliveredAt  DateTime?
  createdAt    DateTime     @default(now())

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  endpoint WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
}

model FeatureFlag {
  id        String   @id @default(cuid())
  tenantId  String
  module    String
  enabled   Boolean  @default(false)
  updatedBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, module])
  @@index([tenantId])
}
