openapi: 3.1.0
info:
  title: ZARIA Builder API
  version: 1.1.0
  description: |
    API Gateway for ZARIA Builder - Text Edition.
    Includes compatibility bridge endpoints for legacy clients.
servers:
  - url: http://localhost:8080
tags:
  - name: Auth
  - name: Templates
  - name: Documents
  - name: Exports
  - name: Webhooks
  - name: Spine
  - name: Tenants
  - name: Compatibility
paths:
  /health:
    get:
      summary: Service health
      responses:
        "200":
          description: Service healthy

  /v1/auth/register:
    post:
      tags: [Auth]
      summary: Register tenant owner
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        "201":
          description: Authenticated session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /v1/auth/login:
    post:
      tags: [Auth]
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        "200":
          description: Authenticated session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /v1/auth/api-keys:
    post:
      tags: [Auth]
      summary: Create API key
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
      responses:
        "201":
          description: Created API key

  /v1/templates:
    get:
      tags: [Templates]
      summary: List templates
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        "200":
          description: Template list
    post:
      tags: [Templates]
      summary: Create tenant template
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTemplateRequest'
      responses:
        "201":
          description: Created template

  /v1/documents:
    get:
      tags: [Documents]
      summary: List documents
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        "200":
          description: Document list
    post:
      tags: [Documents]
      summary: Create document
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDocumentRequest'
      responses:
        "201":
          description: Created document

  /v1/documents/import:
    post:
      tags: [Documents]
      summary: Import text file
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                title:
                  type: string
                templateId:
                  type: string
                ad:
                  type: number
                pm:
                  type: number
                esi:
                  type: number
      responses:
        "201":
          description: Imported document

  /v1/documents/{documentId}:
    get:
      tags: [Documents]
      summary: Get document
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/DocumentId'
      responses:
        "200":
          description: Document payload

  /v1/documents/{documentId}/process:
    post:
      tags: [Documents]
      summary: Process document
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/DocumentId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                force:
                  type: boolean
      responses:
        "200":
          description: Processed document

  /v1/documents/{documentId}/spine:
    patch:
      tags: [Documents]
      summary: Update document spine metrics
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/DocumentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SpineMetrics'
      responses:
        "200":
          description: Updated document

  /v1/exports/{documentId}:
    post:
      tags: [Exports]
      summary: Create export
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/DocumentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportRequest'
      responses:
        "201":
          description: Export artifact

  /v1/exports/{exportId}:
    get:
      tags: [Exports]
      summary: Get export metadata
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/ExportId'
      responses:
        "200":
          description: Export metadata

  /v1/exports/{exportId}/download:
    get:
      tags: [Exports]
      summary: Download export
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/ExportId'
      responses:
        "200":
          description: Binary export

  /v1/webhooks:
    get:
      tags: [Webhooks]
      summary: List webhook endpoints
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        "200":
          description: Endpoint list
    post:
      tags: [Webhooks]
      summary: Create webhook endpoint
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebhookRequest'
      responses:
        "201":
          description: Created endpoint

  /v1/webhooks/{endpointId}:
    delete:
      tags: [Webhooks]
      summary: Delete endpoint
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - name: endpointId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted

  /v1/webhooks/deliveries:
    get:
      tags: [Webhooks]
      summary: List webhook deliveries
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        "200":
          description: Delivery list

  /v1/spine/evaluate:
    post:
      tags: [Spine]
      summary: Evaluate spine profile
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SpineMetrics'
      responses:
        "200":
          description: Spine profile payload

  /v1/tenants/me:
    get:
      tags: [Tenants]
      summary: Current tenant profile
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      responses:
        "200":
          description: Tenant profile and counters

  /v1/tenants/features/{module}:
    patch:
      tags: [Tenants]
      summary: Update tenant feature flag
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - name: module
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [enabled]
              properties:
                enabled:
                  type: boolean
      responses:
        "200":
          description: Updated feature flag

  /api/modules/{module}/toggle:
    post:
      tags: [Compatibility]
      summary: Legacy module toggle compatibility
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - name: module
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [enabled]
              properties:
                enabled:
                  type: boolean
      responses:
        "200":
          description: Toggle result

  /api/memory/search:
    post:
      tags: [Compatibility]
      summary: Legacy memory search compatibility
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [query]
              properties:
                query:
                  type: string
                limit:
                  type: integer
                  minimum: 1
                  maximum: 50
      responses:
        "200":
          description: Search results

  /api/ollama/generate:
    post:
      tags: [Compatibility]
      summary: Legacy transformation compatibility endpoint
      description: Performs structured transformation only; no text generation.
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title, text]
              properties:
                title:
                  type: string
                text:
                  type: string
                templateId:
                  type: string
                metadata:
                  type: object
                spine:
                  $ref: '#/components/schemas/SpineMetrics'
      responses:
        "200":
          description: Structured transformation payload

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    TenantHeader:
      in: header
      name: x-tenant-id
      required: true
      schema:
        type: string
    DocumentId:
      in: path
      name: documentId
      required: true
      schema:
        type: string
    ExportId:
      in: path
      name: exportId
      required: true
      schema:
        type: string

  schemas:
    RegisterRequest:
      type: object
      required: [tenantName, tenantSlug, email, password, fullName]
      properties:
        tenantName:
          type: string
        tenantSlug:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 12
        fullName:
          type: string

    LoginRequest:
      type: object
      required: [tenantSlug, email, password]
      properties:
        tenantSlug:
          type: string
        email:
          type: string
          format: email
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        token:
          type: string
        tenantId:
          type: string
        userId:
          type: string

    SpineMetrics:
      type: object
      required: [ad, pm, esi]
      properties:
        ad:
          type: number
          minimum: 0
          maximum: 100
        pm:
          type: number
          minimum: 0
          maximum: 100
        esi:
          type: number
          minimum: 0
          maximum: 100

    CreateDocumentRequest:
      type: object
      required: [inputType, title, rawText, templateId, spine]
      properties:
        inputType:
          type: string
          enum: [raw, structured, imported, copywriter]
        title:
          type: string
        rawText:
          type: string
        sourceReference:
          type: string
        templateId:
          type: string
        spine:
          $ref: '#/components/schemas/SpineMetrics'

    ExportRequest:
      type: object
      required: [format]
      properties:
        format:
          type: string
          enum: [pdf, epub, docx, bundle]
        includeFormats:
          type: array
          items:
            type: string
            enum: [pdf, epub, docx]
        spine:
          $ref: '#/components/schemas/SpineMetrics'

    CreateWebhookRequest:
      type: object
      required: [event, targetUrl, secret]
      properties:
        event:
          type: string
          enum: [document.processed, export.completed, export.failed]
        targetUrl:
          type: string
          format: uri
        secret:
          type: string
          minLength: 16

    CreateTemplateRequest:
      type: object
      required: [id, name, description, typography, palette, coverStyle, pageStyle]
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        typography:
          type: object
          properties:
            headingFont:
              type: string
            bodyFont:
              type: string
            monoFont:
              type: string
        palette:
          type: object
          properties:
            white:
              type: string
            purple:
              type: string
            purpleDeep:
              type: string
            gold:
              type: string
        coverStyle:
          type: string
          enum: [monolith, crest, minimal]
        pageStyle:
          type: string
          enum: [classic, edge, editorial]
